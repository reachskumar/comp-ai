// Compensation Platform - Prisma Schema
// Multi-tenant SaaS for compensation management

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─────────────────────────────────────────────────────────────
// Enums
// ─────────────────────────────────────────────────────────────

enum UserRole {
  ADMIN
  HR_MANAGER
  MANAGER
  ANALYST
  EMPLOYEE
}

enum ImportStatus {
  PENDING
  ANALYZING
  CLEANING
  REVIEW
  APPROVED
  REJECTED
  COMPLETED
  FAILED
}

enum IssueSeverity {
  ERROR
  WARNING
  INFO
}

enum IssueType {
  BOM
  NBSP
  ZERO_WIDTH
  SMART_QUOTE
  ENCODING
  INVALID_FORMAT
  DUPLICATE
  MISSING_REQUIRED
  OUT_OF_RANGE
  CUSTOM
}

enum Resolution {
  AUTO_FIXED
  MANUAL_FIXED
  REJECTED
  IGNORED
}

enum RuleSetStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum RuleType {
  MERIT
  BONUS
  LTI
  PRORATION
  CAP
  FLOOR
  ELIGIBILITY
  CUSTOM
}

enum SimulationStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum CycleType {
  MERIT
  BONUS
  LTI
  COMBINED
}

enum CycleStatus {
  DRAFT
  PLANNING
  ACTIVE
  CALIBRATION
  APPROVAL
  COMPLETED
  CANCELLED
}

enum RecommendationType {
  MERIT_INCREASE
  BONUS
  LTI_GRANT
  PROMOTION
  ADJUSTMENT
}

enum RecommendationStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  ESCALATED
}

enum PayrollStatus {
  DRAFT
  PROCESSING
  REVIEW
  APPROVED
  FINALIZED
  ERROR
}

enum AnomalyType {
  NEGATIVE_NET
  SPIKE
  DROP
  UNUSUAL_DEDUCTION
  MISSING_COMPONENT
  DUPLICATE
  CUSTOM
}

enum AnomalySeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum BenefitPlanType {
  MEDICAL
  DENTAL
  VISION
  LIFE
  DISABILITY
}

enum BenefitTier {
  EMPLOYEE
  EMPLOYEE_SPOUSE
  EMPLOYEE_CHILDREN
  FAMILY
}

enum EnrollmentStatus {
  ACTIVE
  PENDING
  TERMINATED
  WAIVED
}

enum EnrollmentWindowStatus {
  UPCOMING
  OPEN
  CLOSED
}

enum LifeEventType {
  MARRIAGE
  BIRTH
  ADOPTION
  DIVORCE
  LOSS_OF_COVERAGE
  ADDRESS_CHANGE
}

enum DependentRelationship {
  SPOUSE
  CHILD
  DOMESTIC_PARTNER
}

enum ExchangeRateSource {
  MANUAL
  ECB
  OPENEXCHANGE
}

// ─────────────────────────────────────────────────────────────
// Tenancy & Auth
// ─────────────────────────────────────────────────────────────

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  plan      String   @default("free")
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users               User[]
  employees           Employee[]
  importJobs          ImportJob[]
  ruleSets            RuleSet[]
  simulationRuns      SimulationRun[]
  compCycles          CompCycle[]
  payrollRuns         PayrollRun[]
  auditLogs           AuditLog[]
  notifications       Notification[]
  integrationConnectors IntegrationConnector[]
  benefitPlans        BenefitPlan[]
  benefitEnrollments  BenefitEnrollment[]
  enrollmentWindows   EnrollmentWindow[]
  lifeEvents          LifeEvent[]
  meritMatrices       MeritMatrix[]
  salaryBands         SalaryBand[]
  marketDataSources   MarketDataSource[]
  adHocIncreases      AdHocIncrease[]
  exchangeRates       ExchangeRate[]
  tenantCurrency      TenantCurrency?

  @@map("tenants")
}

model User {
  id           String   @id @default(cuid())
  tenantId     String
  email        String
  name         String
  passwordHash String?
  role         UserRole @default(EMPLOYEE)
  avatarUrl    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant              Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  importJobs          ImportJob[]
  simulationRuns      SimulationRun[]
  approvedRecs        CompRecommendation[]
  auditLogs           AuditLog[]
  notifications       Notification[]
  adHocRequested      AdHocIncrease[]    @relation("AdHocRequestedBy")
  adHocApproved       AdHocIncrease[]    @relation("AdHocApprover")

  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("users")
}

// ─────────────────────────────────────────────────────────────
// Employee Master
// ─────────────────────────────────────────────────────────────

model Employee {
  id              String    @id @default(cuid())
  tenantId        String
  employeeCode    String
  email           String
  firstName       String
  lastName        String
  department      String
  level           String
  location        String?
  managerId       String?
  hireDate        DateTime
  terminationDate DateTime?
  currency        String    @default("USD")
  baseSalary      Decimal   @default(0) @db.Decimal(12, 2)
  totalComp       Decimal   @default(0) @db.Decimal(12, 2)
  metadata        Json      @default("{}")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  manager         Employee? @relation("EmployeeManager", fields: [managerId], references: [id], onDelete: SetNull)
  directReports   Employee[] @relation("EmployeeManager")

  performanceRating  Decimal?  @db.Decimal(3, 1)

  jobFamily       String?
  compaRatio      Decimal?  @db.Decimal(5, 4)
  salaryBandId    String?

  recommendations    CompRecommendation[]
  cycleBudgets       CycleBudget[]
  payrollLineItems   PayrollLineItem[]
  payrollAnomalies   PayrollAnomaly[]
  benefitEnrollments BenefitEnrollment[]
  benefitDependents  BenefitDependent[]
  lifeEvents            LifeEvent[]
  compensationLetters   CompensationLetter[]
  salaryBand            SalaryBand?   @relation(fields: [salaryBandId], references: [id], onDelete: SetNull)
  adHocIncreases        AdHocIncrease[]

  @@unique([tenantId, employeeCode])
  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([tenantId, department])
  @@index([managerId])
  @@index([salaryBandId])
  @@map("employees")
}

// ─────────────────────────────────────────────────────────────
// Data Hygiene (Module 3)
// ─────────────────────────────────────────────────────────────

model ImportJob {
  id          String       @id @default(cuid())
  tenantId    String
  userId      String
  fileName    String
  fileSize    Int
  encoding    String       @default("utf-8")
  status      ImportStatus @default(PENDING)
  totalRows   Int          @default(0)
  cleanRows   Int          @default(0)
  rejectRows  Int          @default(0)
  settings    Json         @default("{}")
  createdAt   DateTime     @default(now())
  completedAt DateTime?
  updatedAt   DateTime     @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  issues ImportIssue[]
  aiAnalyses ImportAIAnalysis[]

  @@index([tenantId])
  @@index([userId])
  @@index([tenantId, status])
  @@map("import_jobs")
}

model ImportIssue {
  id            String        @id @default(cuid())
  importJobId   String
  row           Int
  column        Int?
  fieldName     String
  issueType     IssueType
  severity      IssueSeverity
  originalValue String?
  cleanedValue  String?
  resolution    Resolution?
  createdAt     DateTime      @default(now())

  importJob ImportJob @relation(fields: [importJobId], references: [id], onDelete: Cascade)

  @@index([importJobId])
  @@index([importJobId, severity])
  @@map("import_issues")
}

// ─────────────────────────────────────────────────────────────
// Rules Engine (Module 2)
// ─────────────────────────────────────────────────────────────

model RuleSet {
  id            String        @id @default(cuid())
  tenantId      String
  name          String
  description   String?
  version       Int           @default(1)
  status        RuleSetStatus @default(DRAFT)
  effectiveDate DateTime?
  schema        Json          @default("{}")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  rules          Rule[]
  simulationRuns SimulationRun[]
  testCases      TestCase[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@map("rule_sets")
}

model Rule {
  id         String   @id @default(cuid())
  ruleSetId  String
  name       String
  ruleType   RuleType
  priority   Int      @default(0)
  conditions Json     @default("{}")
  actions    Json     @default("{}")
  metadata   Json     @default("{}")
  enabled    Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  ruleSet RuleSet @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)

  @@index([ruleSetId])
  @@index([ruleSetId, ruleType])
  @@map("rules")
}

model SimulationRun {
  id            String           @id @default(cuid())
  tenantId      String
  ruleSetId     String
  userId        String
  status        SimulationStatus @default(PENDING)
  parameters    Json             @default("{}")
  impactSummary Json?
  createdAt     DateTime         @default(now())
  completedAt   DateTime?
  updatedAt     DateTime         @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  ruleSet RuleSet @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  results SimulationResult[]

  @@index([tenantId])
  @@index([ruleSetId])
  @@map("simulation_runs")
}

model SimulationResult {
  id              String  @id @default(cuid())
  simulationRunId String
  employeeId      String?
  input           Json    @default("{}")
  output          Json    @default("{}")
  delta           Json?
  createdAt       DateTime @default(now())

  simulationRun SimulationRun @relation(fields: [simulationRunId], references: [id], onDelete: Cascade)

  @@index([simulationRunId])
  @@map("simulation_results")
}

model TestCase {
  id             String  @id @default(cuid())
  ruleSetId      String
  name           String
  input          Json    @default("{}")
  expectedOutput Json    @default("{}")
  actualOutput   Json?
  passed         Boolean?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  ruleSet RuleSet @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)

  @@index([ruleSetId])
  @@map("test_cases")
}

// ─────────────────────────────────────────────────────────────
// Compensation Cycle (Module 1)
// ─────────────────────────────────────────────────────────────

model CompCycle {
  id          String      @id @default(cuid())
  tenantId    String
  name        String
  cycleType   CycleType
  status      CycleStatus @default(DRAFT)
  budgetTotal Decimal     @default(0) @db.Decimal(14, 2)
  currency    String      @default("USD")
  startDate   DateTime
  endDate     DateTime
  settings    Json        @default("{}")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  meritMatrixId       String?

  tenant              Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  meritMatrix         MeritMatrix?         @relation(fields: [meritMatrixId], references: [id], onDelete: SetNull)
  budgets             CycleBudget[]
  recommendations     CompRecommendation[]
  calibrationSessions CalibrationSession[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@map("comp_cycles")
}

model CycleBudget {
  id         String  @id @default(cuid())
  cycleId    String
  department String
  managerId  String?
  allocated  Decimal @default(0) @db.Decimal(14, 2)
  spent      Decimal @default(0) @db.Decimal(14, 2)
  remaining  Decimal @default(0) @db.Decimal(14, 2)
  driftPct   Decimal @default(0) @db.Decimal(5, 2)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  cycle   CompCycle @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  manager Employee? @relation(fields: [managerId], references: [id], onDelete: SetNull)

  @@index([cycleId])
  @@index([cycleId, department])
  @@map("cycle_budgets")
}

model CompRecommendation {
  id             String               @id @default(cuid())
  cycleId        String
  employeeId     String
  recType        RecommendationType
  currentValue   Decimal              @default(0) @db.Decimal(12, 2)
  proposedValue  Decimal              @default(0) @db.Decimal(12, 2)
  justification  String?
  status         RecommendationStatus @default(DRAFT)
  approverUserId String?
  approvedAt     DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  cycle    CompCycle @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  employee Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  approver User?     @relation(fields: [approverUserId], references: [id], onDelete: SetNull)

  @@index([cycleId])
  @@index([employeeId])
  @@index([cycleId, status])
  @@map("comp_recommendations")
}

model CalibrationSession {
  id           String      @id @default(cuid())
  cycleId      String
  name         String
  status       CycleStatus @default(DRAFT)
  participants Json        @default("[]")
  outcomes     Json        @default("{}")
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  cycle CompCycle @relation(fields: [cycleId], references: [id], onDelete: Cascade)

  @@index([cycleId])
  @@map("calibration_sessions")
}

// ─────────────────────────────────────────────────────────────
// Payroll (Module 9)
// ─────────────────────────────────────────────────────────────

model PayrollRun {
  id            String        @id @default(cuid())
  tenantId      String
  period        String
  status        PayrollStatus @default(DRAFT)
  totalGross    Decimal       @default(0) @db.Decimal(14, 2)
  totalNet      Decimal       @default(0) @db.Decimal(14, 2)
  employeeCount Int           @default(0)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  tenant    Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lineItems PayrollLineItem[]
  anomalies PayrollAnomaly[]

  @@index([tenantId])
  @@index([tenantId, period])
  @@map("payroll_runs")
}

model PayrollLineItem {
  id             String  @id @default(cuid())
  payrollRunId   String
  employeeId     String
  component      String
  amount         Decimal @default(0) @db.Decimal(12, 2)
  previousAmount Decimal @default(0) @db.Decimal(12, 2)
  delta          Decimal @default(0) @db.Decimal(12, 2)
  createdAt      DateTime @default(now())

  payrollRun PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)
  employee   Employee   @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([payrollRunId])
  @@index([employeeId])
  @@map("payroll_line_items")
}

model PayrollAnomaly {
  id           String          @id @default(cuid())
  payrollRunId String
  employeeId   String
  anomalyType  AnomalyType
  severity     AnomalySeverity
  details      Json            @default("{}")
  resolved     Boolean         @default(false)
  resolvedBy   String?
  resolvedAt   DateTime?
  createdAt    DateTime        @default(now())

  payrollRun  PayrollRun          @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)
  employee    Employee            @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  explanation AnomalyExplanation?

  @@index([payrollRunId])
  @@index([employeeId])
  @@index([payrollRunId, resolved])
  @@map("payroll_anomalies")
}

model AnomalyExplanation {
  id                  String   @id @default(cuid())
  anomalyId           String   @unique
  explanation         String   @db.Text
  rootCause           String   @db.Text
  contributingFactors Json     @default("[]")
  recommendedAction   String   @default("flag")
  confidence          Float    @default(0)
  reasoning           String   @db.Text
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  anomaly PayrollAnomaly @relation(fields: [anomalyId], references: [id], onDelete: Cascade)

  @@index([anomalyId])
  @@map("anomaly_explanations")
}

// ─────────────────────────────────────────────────────────────
// Integration Hub
// ─────────────────────────────────────────────────────────────

enum ConnectorType {
  HRIS
  PAYROLL
  BENEFITS
  SSO
  CUSTOM
}

enum ConnectorStatus {
  ACTIVE
  INACTIVE
  ERROR
  PENDING
}

enum SyncDirection {
  INBOUND
  OUTBOUND
  BIDIRECTIONAL
}

enum SyncSchedule {
  REALTIME
  HOURLY
  DAILY
  MANUAL
}

enum SyncJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum SyncLogAction {
  CREATE
  UPDATE
  DELETE
  SKIP
  ERROR
}

enum ConflictStrategy {
  LAST_WRITE_WINS
  MANUAL_REVIEW
  SOURCE_PRIORITY
}

model IntegrationConnector {
  id               String          @id @default(cuid())
  tenantId         String
  name             String
  connectorType    ConnectorType
  status           ConnectorStatus @default(PENDING)
  config           Json            @default("{}")
  encryptedCredentials String?
  credentialIv     String?
  credentialTag    String?
  syncDirection    SyncDirection   @default(INBOUND)
  syncSchedule     SyncSchedule    @default(MANUAL)
  conflictStrategy ConflictStrategy @default(LAST_WRITE_WINS)
  lastSyncAt       DateTime?
  lastHealthCheck  DateTime?
  healthStatus     String?
  metadata         Json            @default("{}")
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  syncJobs        SyncJob[]
  fieldMappings   FieldMapping[]
  webhookEndpoints WebhookEndpoint[]

  @@index([tenantId])
  @@index([tenantId, connectorType])
  @@index([tenantId, status])
  @@map("integration_connectors")
}

model SyncJob {
  id            String        @id @default(cuid())
  connectorId   String
  tenantId      String
  direction     SyncDirection
  entityType    String
  status        SyncJobStatus @default(PENDING)
  totalRecords  Int           @default(0)
  processedRecords Int        @default(0)
  failedRecords Int           @default(0)
  skippedRecords Int          @default(0)
  startedAt     DateTime?
  completedAt   DateTime?
  errorMessage  String?
  metadata      Json          @default("{}")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  connector     IntegrationConnector @relation(fields: [connectorId], references: [id], onDelete: Cascade)
  syncLogs      SyncLog[]

  @@index([connectorId])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([connectorId, createdAt])
  @@map("sync_jobs")
}

model SyncLog {
  id          String        @id @default(cuid())
  syncJobId   String
  entityId    String
  entityType  String
  action      SyncLogAction
  sourceData  Json?
  targetData  Json?
  diff        Json?
  errorMessage String?
  createdAt   DateTime      @default(now())

  syncJob     SyncJob       @relation(fields: [syncJobId], references: [id], onDelete: Cascade)

  @@index([syncJobId])
  @@index([syncJobId, action])
  @@index([syncJobId, entityId])
  @@map("sync_logs")
}

model FieldMapping {
  id            String   @id @default(cuid())
  connectorId   String
  tenantId      String
  sourceField   String
  targetField   String
  transformType String   @default("direct")
  transformConfig Json   @default("{}")
  isRequired    Boolean  @default(false)
  defaultValue  String?
  enabled       Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  connector     IntegrationConnector @relation(fields: [connectorId], references: [id], onDelete: Cascade)

  @@index([connectorId])
  @@index([tenantId])
  @@index([connectorId, enabled])
  @@map("field_mappings")
}

model WebhookEndpoint {
  id            String   @id @default(cuid())
  connectorId   String
  tenantId      String
  url           String
  direction     String   @default("inbound")
  events        Json     @default("[]")
  secretHash    String?
  isActive      Boolean  @default(true)
  lastTriggeredAt DateTime?
  failureCount  Int      @default(0)
  metadata      Json     @default("{}")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  connector     IntegrationConnector @relation(fields: [connectorId], references: [id], onDelete: Cascade)

  @@index([connectorId])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@map("webhook_endpoints")
}

// ─────────────────────────────────────────────────────────────
// Benefits (Module — Health & Insurance)
// ─────────────────────────────────────────────────────────────

model BenefitPlan {
  id              String          @id @default(cuid())
  tenantId        String
  planType        BenefitPlanType
  name            String
  carrier         String
  description     String?
  network         String?
  premiums        Json            @default("{}") // { EMPLOYEE: 150, EMPLOYEE_SPOUSE: 350, ... }
  deductibles     Json            @default("{}") // { individual: 500, family: 1500 }
  outOfPocketMax  Json            @default("{}") // { individual: 3000, family: 6000 }
  copays          Json            @default("{}") // { primaryCare: 25, specialist: 50, ... }
  coverageDetails Json            @default("{}") // plan-specific coverage info
  effectiveDate   DateTime
  endDate         DateTime?
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  tenant      Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  enrollments BenefitEnrollment[]

  @@index([tenantId])
  @@index([tenantId, planType])
  @@index([tenantId, isActive])
  @@map("benefit_plans")
}

model BenefitEnrollment {
  id            String           @id @default(cuid())
  tenantId      String
  employeeId    String
  planId        String
  tier          BenefitTier
  status        EnrollmentStatus @default(PENDING)
  effectiveDate DateTime
  endDate       DateTime?
  employeePremium  Decimal       @default(0) @db.Decimal(10, 2)
  employerPremium  Decimal       @default(0) @db.Decimal(10, 2)
  electedAt     DateTime?
  metadata      Json             @default("{}")
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  tenant     Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee   Employee            @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  plan       BenefitPlan         @relation(fields: [planId], references: [id], onDelete: Cascade)
  dependents BenefitDependent[]

  @@index([tenantId])
  @@index([tenantId, employeeId])
  @@index([tenantId, planId])
  @@index([tenantId, status])
  @@map("benefit_enrollments")
}

model BenefitDependent {
  id             String                @id @default(cuid())
  employeeId     String
  enrollmentId   String?
  firstName      String
  lastName       String
  relationship   DependentRelationship
  dateOfBirth    DateTime
  ssnEncrypted   String?               // AES-256-GCM encrypted SSN
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  employee   Employee           @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  enrollment BenefitEnrollment? @relation(fields: [enrollmentId], references: [id], onDelete: SetNull)

  @@index([employeeId])
  @@index([enrollmentId])
  @@map("benefit_dependents")
}

model EnrollmentWindow {
  id        String                 @id @default(cuid())
  tenantId  String
  name      String
  planYear  Int
  startDate DateTime
  endDate   DateTime
  status    EnrollmentWindowStatus @default(UPCOMING)
  metadata  Json                   @default("{}")
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, planYear])
  @@map("enrollment_windows")
}

model LifeEvent {
  id              String        @id @default(cuid())
  tenantId        String
  employeeId      String
  eventType       LifeEventType
  eventDate       DateTime
  qualifyingDate  DateTime
  description     String?
  documentation   String?       // file path (randomized filename)
  status          String        @default("PENDING") // PENDING, APPROVED, DENIED
  reviewedBy      String?
  reviewedAt      DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, employeeId])
  @@index([tenantId, status])
  @@map("life_events")
}

// ─────────────────────────────────────────────────────────────
// Shared
// ─────────────────────────────────────────────────────────────

model AuditLog {
  id         String   @id @default(cuid())
  tenantId   String
  userId     String?
  action     String
  entityType String
  entityId   String
  changes    Json     @default("{}")
  ipAddress  String?
  createdAt  DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, entityType, entityId])
  @@index([tenantId, createdAt])
  @@map("audit_logs")
}

model Notification {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  type      String
  title     String
  body      String?
  read      Boolean  @default(false)
  metadata  Json     @default("{}")
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId, read])
  @@index([userId, createdAt])
  @@map("notifications")
}

// ─────────────────────────────────────────────────────────────
// Reports — AI-generated natural language reports
// ─────────────────────────────────────────────────────────────

enum ReportStatus {
  GENERATING
  COMPLETED
  FAILED
}

model SavedReport {
  id          String       @id @default(cuid())
  tenantId    String
  userId      String
  title       String
  prompt      String
  status      ReportStatus @default(GENERATING)
  queryType   String?
  filters     Json         @default("{}")
  results     Json         @default("[]")
  chartConfig Json         @default("{}")
  narrative   String?
  errorMsg    String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([tenantId])
  @@index([tenantId, userId])
  @@index([tenantId, createdAt])
  @@map("saved_reports")
}

// ─────────────────────────────────────────────────────────────
// Policy Conversions — AI policy-to-rules conversion history
// ─────────────────────────────────────────────────────────────

enum PolicyConversionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model PolicyConversion {
  id              String                  @id @default(cuid())
  tenantId        String
  userId          String
  fileName        String?
  fileType        String?
  policyText      String
  status          PolicyConversionStatus  @default(PENDING)
  rulesExtracted  Int                     @default(0)
  rulesAccepted   Int                     @default(0)
  rulesRejected   Int                     @default(0)
  result          Json                    @default("{}")
  summary         String?
  errorMessage    String?
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  @@index([tenantId])
  @@index([tenantId, userId])
  @@index([tenantId, createdAt])
  @@map("policy_conversions")
}

// ─────────────────────────────────────────────────────────────
// Compliance — AI Audit & Compliance Scanner
// ─────────────────────────────────────────────────────────────

enum ComplianceScanStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum ComplianceFindingSeverity {
  CRITICAL
  WARNING
  INFO
}

enum ComplianceFindingCategory {
  FLSA_OVERTIME
  PAY_EQUITY
  POLICY_VIOLATION
  BENEFITS_ELIGIBILITY
  REGULATORY_GAP
  DATA_QUALITY
}

model ComplianceScan {
  id              String               @id @default(cuid())
  tenantId        String
  userId          String
  status          ComplianceScanStatus @default(PENDING)
  overallScore    Int?
  riskSummary     Json                 @default("{}")
  scanConfig      Json                 @default("{}")
  aiReport        String?
  errorMsg        String?
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  findings ComplianceFinding[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("compliance_scans")
}

model ComplianceFinding {
  id            String                    @id @default(cuid())
  scanId        String
  category      ComplianceFindingCategory
  severity      ComplianceFindingSeverity
  title         String
  description   String
  explanation   String?
  remediation   String?
  affectedScope Json                      @default("{}")
  metadata      Json                      @default("{}")
  resolved      Boolean                   @default(false)
  createdAt     DateTime                  @default(now())

  scan ComplianceScan @relation(fields: [scanId], references: [id], onDelete: Cascade)

  @@index([scanId])
  @@index([scanId, severity])
  @@index([scanId, category])
  @@map("compliance_findings")
}

// ─────────────────────────────────────────────────────────────
// Compensation Letters — AI-generated compensation letters
// ─────────────────────────────────────────────────────────────

enum LetterType {
  OFFER
  RAISE
  PROMOTION
  BONUS
  TOTAL_COMP_SUMMARY
}

enum LetterStatus {
  DRAFT
  GENERATING
  REVIEW
  APPROVED
  SENT
  FAILED
}

model CompensationLetter {
  id            String       @id @default(cuid())
  tenantId      String
  userId        String
  employeeId    String
  letterType    LetterType
  status        LetterStatus @default(DRAFT)
  subject       String
  content       String       @db.Text
  compData      Json         @default("{}")
  tone          String       @default("professional")
  language      String       @default("en")
  pdfUrl        String?
  batchId       String?
  metadata      Json         @default("{}")
  errorMsg      String?
  generatedAt   DateTime?
  approvedAt    DateTime?
  sentAt        DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, employeeId])
  @@index([tenantId, status])
  @@index([tenantId, batchId])
  @@index([tenantId, createdAt])
  @@map("compensation_letters")
}

// ─────────────────────────────────────────────────────────────
// Import AI Analysis — AI-powered data quality analysis results
// ─────────────────────────────────────────────────────────────

enum ImportAIAnalysisStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

model ImportAIAnalysis {
  id            String                  @id @default(cuid())
  tenantId      String
  userId        String
  importJobId   String
  status        ImportAIAnalysisStatus  @default(PENDING)
  qualityScore  Int?
  summary       String?
  report        Json                    @default("{}")
  rawResponse   String?                 @db.Text
  errorMsg      String?
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt

  importJob ImportJob @relation(fields: [importJobId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([importJobId])
  @@index([tenantId, importJobId])
  @@index([tenantId, createdAt])
  @@map("import_ai_analyses")
}


// ─────────────────────────────────────────────────────────────
// Simulation Scenarios — AI-powered compensation what-if analysis
// ─────────────────────────────────────────────────────────────

enum SimulationScenarioStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

model SimulationScenario {
  id              String                    @id @default(cuid())
  tenantId        String
  userId          String
  name            String?
  prompt          String                    @db.Text
  status          SimulationScenarioStatus  @default(PENDING)
  affectedCount   Int?
  totalCostDelta  Float?
  budgetImpactPct Float?
  results         Json                      @default("{}")
  comparison      Json                      @default("{}")
  response        String?                   @db.Text
  errorMsg        String?
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt

  @@index([tenantId])
  @@index([tenantId, userId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("simulation_scenarios")
}


// ─────────────────────────────────────────────────────────────
// Merit Matrix — performance rating × compa-ratio → increase %
// ─────────────────────────────────────────────────────────────

model MeritMatrix {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  isDefault Boolean  @default(false)
  matrix    Json     @default("[]")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cycles    CompCycle[]

  @@index([tenantId])
  @@map("merit_matrices")
}
// ─────────────────────────────────────────────────────────────
// Market Pricing & Salary Benchmarking
// ─────────────────────────────────────────────────────────────

enum MarketDataProvider {
  MANUAL
  SURVEY
  API
}

enum MarketDataSourceStatus {
  ACTIVE
  INACTIVE
  ERROR
}

model SalaryBand {
  id            String    @id @default(cuid())
  tenantId      String
  jobFamily     String
  level         String
  location      String?
  currency      String    @default("USD")
  p10           Decimal   @db.Decimal(12, 2)
  p25           Decimal   @db.Decimal(12, 2)
  p50           Decimal   @db.Decimal(12, 2)
  p75           Decimal   @db.Decimal(12, 2)
  p90           Decimal   @db.Decimal(12, 2)
  source        String?
  effectiveDate DateTime  @default(now())
  expiresAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employees     Employee[]

  @@index([tenantId])
  @@index([tenantId, jobFamily])
  @@index([tenantId, jobFamily, level])
  @@index([tenantId, jobFamily, level, location])
  @@map("salary_bands")
}

model MarketDataSource {
  id          String                 @id @default(cuid())
  tenantId    String
  name        String
  provider    MarketDataProvider     @default(MANUAL)
  config      Json                   @default("{}")
  lastSyncAt  DateTime?
  status      MarketDataSourceStatus @default(ACTIVE)
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, provider])
  @@map("market_data_sources")
}

// ─────────────────────────────────────────────────────────────
// Ad Hoc / Off-Cycle Increases
// ─────────────────────────────────────────────────────────────

enum AdHocType {
  SPOT_BONUS
  RETENTION_BONUS
  MARKET_ADJUSTMENT
  PROMOTION
  EQUITY_ADJUSTMENT
  OTHER
}

enum AdHocStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
  APPLIED
}

model AdHocIncrease {
  id              String      @id @default(cuid())
  tenantId        String
  employeeId      String
  requestedById   String
  type            AdHocType
  reason          String
  currentValue    Decimal     @default(0) @db.Decimal(12, 2)
  proposedValue   Decimal     @default(0) @db.Decimal(12, 2)
  currency        String      @default("USD")
  effectiveDate   DateTime
  status          AdHocStatus @default(DRAFT)
  approverUserId  String?
  approvedAt      DateTime?
  rejectionReason String?
  appliedAt       DateTime?
  metadata        Json        @default("{}")
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  requestedBy User      @relation("AdHocRequestedBy", fields: [requestedById], references: [id], onDelete: Cascade)
  approver    User?     @relation("AdHocApprover", fields: [approverUserId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([employeeId])
  @@index([requestedById])
  @@map("ad_hoc_increases")
}


// ─────────────────────────────────────────────────────────────
// Multi-Currency
// ─────────────────────────────────────────────────────────────

model ExchangeRate {
  id            String             @id @default(cuid())
  tenantId      String
  fromCurrency  String
  toCurrency    String
  rate          Decimal            @db.Decimal(10, 6)
  effectiveDate DateTime           @default(now())
  source        ExchangeRateSource @default(MANUAL)
  createdAt     DateTime           @default(now())

  tenant        Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, fromCurrency, toCurrency])
  @@map("exchange_rates")
}

model TenantCurrency {
  id                  String   @id @default(cuid())
  tenantId            String   @unique
  baseCurrency        String   @default("USD")
  supportedCurrencies String[] @default(["USD"])
  displayFormat       Json     @default("{}")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("tenant_currencies")
}